@using TimePilot.Web.ViewModels
@model StoryViewModel

@{
    ViewBag.Title = "Stories | Time Pilot";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<div class="modal fade" id="deleteStoriesModal" data-keyboard="false" role="dialog">
    <!-- Warning Pop UP HTML-->
    <div class="modalstuff">
        <header>
            <h2>
                Are you sure you want to deleted selected stories?
            </h2>
        </header>
        <button class="btn closebutton" id="noButton" data-dismiss="modal"> No </button>
        <button class="btn proceedbutton" id="yesButton" data-dismiss="modal"> Yes </button>
    </div>
</div>

@using (Html.BeginForm("Story", "Home", FormMethod.Post, new { @id = "story-form" }))
{
    <div class="container">
        <div class="panel panel-default">
            <div class="panel-heading">
                <h3>Stories</h3>
                <a class="dont-see-stories" href="javascript:void(0);"> Don't see your stories? </a>
            </div>
            <div class="panel-body">
                <div class="story-container form-group">
                    <div class="row row-hcentered">
                        <h2 id="story-point-header">Story Points:<span class="story-point-total"></span></h2>
                        @Html.HiddenFor(m => m.totalStoryPoints,
                                        new { @class = "story-point-total-hidden" })
                    </div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th> Story ID </th>
                                <th> Summary </th>
                                <th> Story Points </th>
                                <th> <span class="glyphicon glyphicon-trash"/> </th>
                            </tr>
                        </thead>
                        <tbody>
                            @for (int i = 0; i < Model.StoryList.Count(); i++)
                            {
                            <tr>
                                @Html.HiddenFor(m => m.StoryList[i].StoryID)
                                @Html.HiddenFor(m => m.StoryList[i].StoryKey)
                                @Html.HiddenFor(m => m.StoryList[i].Summary)
                                <td id="story-id-cell"> <a href="https://pnimedia.jira.com/browse/@Model.StoryList[i].StoryKey" target="_blank">@Model.StoryList[i].StoryKey</a></td>
                                <td> <p>@Model.StoryList[i].Summary</p> </td>
                                <td id="story-points-cell">
                                    <fieldset class="radio-group">
                                        <div class="btn-group" data-toggle="buttons">
                                            <label class="btn btn-default btn-radio @(Model.StoryList[i].StoryPoints == 1 ? "active" : "")">1 

                                                @Html.RadioButtonFor(m => m.StoryList[i].StoryPoints, "1",
                                                                     checked(Model.StoryList[i].StoryPoints == 1))
                                            </label>
                                            <label class="btn btn-default btn-radio @(Model.StoryList[i].StoryPoints == 3 ? "active" : "")">3
                                                @Html.RadioButtonFor(m => m.StoryList[i].StoryPoints, "3",
                                                                     checked(Model.StoryList[i].StoryPoints == 3))
                                            </label>
                                            <label class="btn btn-default btn-radio @(Model.StoryList[i].StoryPoints == 5 ? "active" : "")">5
                                                @Html.RadioButtonFor(m => m.StoryList[i].StoryPoints, "5",
                                                                     checked(Model.StoryList[i].StoryPoints == 5))
                                            </label>
                                            <label class="btn btn-default btn-radio @(Model.StoryList[i].StoryPoints == 8 ? "active" : "")">8
                                                @Html.RadioButtonFor(m => m.StoryList[i].StoryPoints, "8",
                                                                     checked (Model.StoryList[i].StoryPoints == 8))
                                            </label>
                                            <label class="btn btn-default btn-radio @(Model.StoryList[i].StoryPoints == 13 ? "active" : "")">13
                                                @Html.RadioButtonFor(m => m.StoryList[i].StoryPoints, "13",
                                                                     checked(Model.StoryList[i].StoryPoints == 13))
                                            </label>
                                            <label class="btn btn-default btn-radio @(Model.StoryList[i].StoryPoints == 21 ? "active" : "")">21
                                                @Html.RadioButtonFor(m => m.StoryList[i].StoryPoints, "21",
                                                                     checked(Model.StoryList[i].StoryPoints == 21))
                                            </label>
                                        </div>
                                    </fieldset>
                                </td>
                                <td> <input type="checkbox" name="chk-delete" value="@Model.StoryList[i].StoryID"/> </td>
                            </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        
            <div class="crud-control-panel">
                <div class="crud-left btn-group">
                    <button class="btn btn-info ctrl-btn btn-populate"><span class="glyphicon glyphicon-refresh"></span> &nbsp; Refresh Stories</button>
                    @*<button class="btn btn-info ctrl-btn btn-populate"><span class="glyphicon glyphicon-refresh"></span> &nbsp; Refresh (Save)</button>*@
                </div>
                <div class="crud-right btn-group">
                    <button class="btn btn-danger  ctrl-btn delete-selected btn-delete"><span class="glyphicon glyphicon-trash"></span> &nbsp; Delete Selected</button>
                </div>
            </div>
        </div>
        <div class="nav-control-panel">
            <button class="btn ctrl-btn btn-primary nav-btn btn-prev"><span class="glyphicon glyphicon-menu-left"></span>&nbsp;Projects</button>
            <button class="btn ctrl-btn btn-primary nav-btn btn-next">Resource Capacity&nbsp;<span class="glyphicon glyphicon-menu-right"></span></button>
        </div>
    </div>
}
<div id="loading"><div id="loading_anim"></div></div>


<script>
    // Initialize story point sum
    $(document).ready(function () {
        $('#loading').hide();
        sumStoryPoints()
    });

    // Always save changes
    $(window).bind('beforeunload', function () {
        postStoryForm();
    });

    // Delete Selected button
    $(".btn-delete").on("click", function (e) {
        e.preventDefault();
        var c = confirm("Delete stories?");
        if (c) { deleteStoryForm() };
    })
    function deleteStoryForm() {
        var data = [];
        $("input[name='chk-delete']:checked").each(function () {
            data.push($(this).val());
        });
        if (data.length == 0) {
            return;
        }
        else if (data.length >0) {
            $.ajax({
                type: "POST",
                url: "@Url.Action("StoryDelete")",
                data: { id: data },
                traditional: true,
                success: function (result) {
                    //Modify DOM
                    $("input[name='chk-delete']:checked").each(function () {
                        $(this.parentNode.parentNode).remove();
                    })
                    sumStoryPoints();
                }
            })
        }
    }

    // Refresh stories button
    $('.btn-populate').on('click', function (e) {
        e.preventDefault();
        var c = confirm("Story point changes will be lost on refresh");
        if (c) { refreshStoryForm() };
    })
    $('.dont-see-stories').on('click', function (e) {
        e.preventDefault();
        var c = confirm("Story point changes will be lost on refresh");
        if (c) { refreshStoryForm() };
    })
    function refreshStoryForm() {
        $('#loading').show();
        $.ajax({
            type: "GET",
            url: "@Url.Action("StoryPopulate")",
            traditional:true,
            success: function () {
                location.reload();
            }
        })
    }

    // Navigate to resource page
    $('.btn-next').on('click', function(e) {
        e.preventDefault();
        window.location.href = "@Url.Action("Resource", "Home")"
    })

    // Navigate to previous page
    $('.btn-prev').on('click', function(e) {
        e.preventDefault();
        window.location.href = "@Url.Action("Index", "Home")"
    })

    // Posts data
    function postStoryForm() {
        var data = $('#story-form').serialize();
        $.ajax({
            type: "POST",
            url: "@Url.Action("StoryUpdate")",
            data: data,
            traditional: true,
            success: function () {
                window.location.href("@Url.Action("Resource", "Home")");
            }
        })
    }

    // Story Point sum
    $('input:radio').on('change', function(){
        sumStoryPoints()
    });
    function sumStoryPoints() {
        var total = 0;
        $("input[type='radio']:checked").each(function () {
            total += parseInt(this.value);
        });
        document.getElementsByClassName('story-point-total')[0].textContent = " " + total;
        $('.story-point-total-hidden').val(total);
    }
</script>

