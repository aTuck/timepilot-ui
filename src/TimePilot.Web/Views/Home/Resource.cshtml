@model TimePilot.Web.ViewModels.ResourceCapacityViewModel
@using System.Linq;

@{
    ViewBag.Title = "Resources | Time Pilot";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@section resource{<link href="~/Content/resource-new.css" rel="stylesheet" />}

@* Negative value modal *@
<button class="btn-modal" id="btn-trigger-negative-value-modal" data-toggle="modal" data-target="#negative-value-modal"></button>
<div id="negative-value-modal" class="modal fade" role="dialog">
    <div class="modal-dialog">

        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h3 class="modal-title">Invalid Capacities</h3>
            </div>
            <div class="modal-body">
                <img class="modal-warning" src="~/Content/embarrassed.svg" />
                <h3 class="modal-text">Oops, those capacities aren't right. Try getting them above zero.</h3>
            </div>
            <div class="modal-footer">
                <button type="button" id="btn-close-modal" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div>

    </div>
</div>

@* Delete member modal *@
<button class="btn-modal" id="btn-trigger-delete-member-modal" data-toggle="modal" data-target="#delete-member-modal"></button>
<div id="delete-member-modal" class="modal fade" role="dialog">
    <div class="modal-dialog">

        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h3 class="modal-title">Delete Members</h3>
            </div>
            <div class="modal-body">
                <img class="modal-warning" src="~/Content/delete-sprint.svg" />
                <h3 class="modal-text">Are you sure you want to delete these members?</h3>
            </div>
            <div class="modal-footer">
                <button type="button" id="btn-delete-member-yes" class="btn btn-default" data-dismiss="modal">Yes</button>
                <button type="button" id="btn-close-modal" class="btn btn-primary" data-dismiss="modal">No</button>
            </div>
        </div>

    </div>
</div>

@* Delete sprint modal *@
<button class="btn-modal" id="btn-trigger-delete-sprint-modal" data-toggle="modal" data-target="#delete-sprint-modal"></button>
<div id="delete-sprint-modal" class="modal fade" role="dialog">
    <div class="modal-dialog">

        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h3 class="modal-title">Delete Sprint</h3>
            </div>
            <div class="modal-body">
                <img class="modal-warning" src="~/Content/delete-sprint.svg" />
                <h3 class="modal-text">Are you sure you want to delete this sprint?</h3>
            </div>
            <div class="modal-footer">
                <button type="button" id="btn-delete-sprint-yes" class="btn btn-default" data-dismiss="modal">Yes</button>
                <button type="button" id="btn-close-modal" class="btn btn-primary" data-dismiss="modal">No</button>
            </div>
        </div>

    </div>
</div>


@using (Html.BeginForm("Resource", "Home", FormMethod.Post, new { @id = "resource-form" }))
{
    int memberTotal = 0;
    Model.pageState = new List<int>();
    <div class="container">
        @for (int i = 0; i < Model.sprints.Count(); i++)
        {
            int membersInThisSprint = 0;
            Model.pageState.Add(0);
            Model.sprints[i].PageID = i;
            <div id="@i" class="panel panel-default">
                @Html.HiddenFor(m => m.sprints[i].SprintID, new { @class = "sprint-id" })
                <div class="panel-heading sprint-heading">
                    <div class="sprint-control-panel editable">
                        <div class="input-group">
                            <h3 class="sprint-name" id="sprint-name-@i">
                            @{if (!String.IsNullOrEmpty(Model.sprints[i].Name))
                                {
                                    @Html.Raw(Model.sprints[i].Name);
                                }
                                else
                                {
                                    @Html.Raw("Enter Sprint Name...")
                                }
                              }
                            </h3>
                            @Html.HiddenFor(m => m.sprints[i].Name, new { @id = "sprint-name-" + i + "-hidden" })
                            <input class="page-id" type="hidden" id="sprints_@(i)__PageID" name="sprints[@(i)].PageID" value="@i" />
                        </div>
                        <div class="btn-control-panel">
                            <button type="button" class="btn btn-primary add-member-btn" id="@i"><span class="glyphicon glyphicon-plus-sign"></span><span class="add-member-text">&nbsp; Add Member</span></button>
                            @{if (i != 0)
                                {
                                    <span class="sprint-remove glyphicon glyphicon-remove" />
                                }
                            }
                        </div>
                    </div>
                </div>
                <div class="panel-body">
                    <table class="table">
                        <thead>
                            <tr>
                                <th><span class="glyphicon glyphicon-trash trash-select-all" /></th>
                                <th><span class="glyphicon glyphicon-user"/></th>
                                <th>Name</th>
                                <th>Sprint Days</th>
                                <th>% Work</th>
                                <th>Total Hrs</th>
                                <th>SU Length</th>
                                <th>Total SU</th>
                                <th>Misc &nbsp;<a href="#" data-toggle="popover" data-placement="bottom" title="Miscellaneous" data-content="Meetings (Backlog Review, Dev Meeting), Demos/Retros, Sprint Planning"><span class="glyphicon glyphicon-question-sign"></span></a></th>
                                <th>Time Off &nbsp;<a href="#" data-toggle="popover" data-placement="bottom" title="Time Off" data-content="Any sick days, holidays, vacation time, or other time off here "><span class="glyphicon glyphicon-question-sign"></span></a></th>
                                <th>Non Dev</th>
                                <th>Capacity</th>
                            </tr>
                        </thead>
                        <tbody>
                        @for (int j = 0; j < Model.members.Count; j++)
                        {
                            if (Model.members[j].SprintID == Model.sprints[i].SprintID)
                            {
                                Model.pageState[i]++;
                                <tr id="@i-@membersInThisSprint" class="member-row">
                                    <input type="hidden" class="sprint-id" id="members_@(memberTotal)__SprintID" name="members[@(memberTotal)].SprintID" value="@Model.members[j].SprintID" />
                                    <input type="hidden" class="page-id" id="members_@(memberTotal)__PageID" name="members[@(memberTotal)].PageID" value="@i" />
                                    @Html.HiddenFor(m => m.members[j].MemberID)
                                    <td id="checkbox-cell">@{if (j != 0)
                                        {
                                            <input type="checkbox" name="chkDelete" value="@Model.members[j].MemberID" />
                                        }
                                    }</td>
                                    <td>
                                        <select class="role-select" id="members_@(memberTotal)__Role" name="members[@(memberTotal)].Role">
                                            <option value="leadDev" @{ if (Model.members[j].Role == "leadDev") {@Html.Raw("selected='selected'") }}>Lead Dev</option>
                                            <option value="seniorDev" @{ if (Model.members[j].Role == "seniorDev") {@Html.Raw("selected='selected'") }}>Senior Dev</option>
                                            <option value="intermediateDev" @{ if (Model.members[j].Role == "intermediateDev") {@Html.Raw("selected='selected'") }}>Regular Dev</option>
                                            <option value="juniorDev" @{ if (Model.members[j].Role == "juniorDev") {@Html.Raw("selected='selected'") }}>Junior Dev</option>
                                            <option value="leadQA" @{ if (Model.members[j].Role == "leadQA") {@Html.Raw("selected='selected'") }}>Lead QA</option>
                                            <option value="seniorQA" @{ if (Model.members[j].Role == "seniorQA") {@Html.Raw("selected='selected'") }}>Senior QA</option>
                                            <option value="intermediateQA" @{ if (Model.members[j].Role == "intermediateQA") {@Html.Raw("selected='selected'") }}>Regular QA</option>
                                            <option value="juniorQA" @{ if (Model.members[j].Role == "juniorQA") {@Html.Raw("selected='selected'") }}>Junior QA</option>
                                        </select>
                                    </td>
                                    <td>@Html.TextBoxFor(m => m.members[j].Name, new { @class = "form-control form-control-name", placeholder = "Name" })</td>
                                    <td>@Html.TextBoxFor(m => m.members[j].SprintDays, new { @class = "form-control raw-data", type="number", min="0", max="99" })</td>
                                    <td>@Html.TextBoxFor(m => m.members[j].PercentWork, new { @class = "form-control raw-data", type = "number", min = "0", max = "99" })</td>
                                    <td><input type="text" class="form-control total" Name="totalHours" readonly /></td>
                                    <td>@Html.TextBoxFor(m => m.members[j].StandupDuration, new { @class = "form-control raw-data", type = "number", min = "0", max = "1", step="0.05" })</td>
                                    <td><input type="text" class="form-control total" Name="standUps" readonly /></td>
                                    <td>@Html.TextBoxFor(m => m.members[j].Misc, new { @class = "form-control raw-data", type = "number", min = "0", max = "99" })</td>
                                    <td>@Html.TextBoxFor(m => m.members[j].TimeOff, new { @class = "form-control raw-data", type = "number", min = "0", max = "99" })</td>
                                    <td><input type="text" class="form-control total" Name="nonDevHours" readonly /></td>
                                    <td><input type="text" class="form-control total" Name="totalAvailable" readonly /></td>
                                </tr>
                                membersInThisSprint++;
                                memberTotal++;
                            }
                        }
                        <tr id="@i-@membersInThisSprint"></tr> @*placeholder member*@
                        </tbody>
                    </table>
                </div>
            </div>
            if (i == (Model.sprints.Count() - 1))
            {
                <div id="@(i+1)" class="panel panel-default" style="display:none;"></div> @*placeholder sprint*@
            }
        }
        <div class="crud-control-panel">
            <button class="btn btn-lg btn-primary ctrl-btn add-sprint" data-toggle="tooltip" title="Add a sprint" data-placement="right"> + </button>
            <div class="form-group">
                <label>Total Dev Capacity</label>
                <div class="final-value">0</div>
            </div>
            <div class="form-group">
                <label>Average Per Sprint</label>
                <div class="final-value">0</div>
            </div>
            <div class="form-group">
                <label>Average Per Week</label>
                <div class="final-value">0</div>
            </div>
                <button class="delete-selected btn btn-danger ctrl-btn"><span class="glyphicon glyphicon-trash"></span> &nbsp; Delete Selected</button>
            </div>

        @Html.HiddenFor(m => m.totalDevCapacity, new { @class = "total-dev-capacity-hidden" })
        <div class="nav-control-panel">
            <button class="btn ctrl-btn btn-primary nav-btn btn-prev"><span class="glyphicon glyphicon-menu-left"></span>&nbsp; Stories </button>
            <button class="btn ctrl-btn btn-primary nav-btn btn-next">Results &nbsp; <span class="glyphicon glyphicon-menu-right"></span></button>
        </div>
    </div>
}
<script type="text/javascript">
    // Popovers
    $(document).ready(function () {
        $('[data-toggle="popover"]').popover({
            html: true
        });
    });
    $(document).on('click', function (e) {
        $('[data-toggle="popover"],[data-original-title]').each(function () {
            if (!$(this).is(e.target) && $(this).has(e.target).length === 0 && $('.popover').has(e.target).length === 0 ) {
                (($(this).popover('hide').data('bs.popover') || {}).inState || {}).click = false
            }
        });
    });

    // Tooltip
    $(document).ready(function(){
        $('[data-toggle="tooltip"]').tooltip();
    });

    /* limit input lengths */
    $(document).on('keydown', '.raw-data', function(e) {
        var keycode = e.keyCode;
        // 69 = e, 189 = -, 190 = .
        if (keycode == 69 || keycode == 189 || keycode == 190) {
            e.preventDefault();
        // 16 = shift, 17 = ctrl, 8 = backspace, 37/38/39/40 = left, up, right, down arrows
        // Enabling these for usability on number inputs because otherwise they do nothing with max length of 2
        }else if(this.value.length==2 && getSelectedText() || keycode == 16 || keycode == 17 || keycode == 8
                                                           || keycode == 37 || keycode == 38 || keycode == 39 || keycode == 40){
            return true;
        }else if(this.value.length==2 ){
            return false;
        }
    });
    $('.team-velocity').on('keypress', function(e) {
        var keycode = e.charCode || e.keyCode;
        if (keycode == 46) {
            return false;
        }else if(this.value.length==3 && getSelectedText()){
            return true;
        }else if(this.value.length==3 ){
            return false;
        }
    });
    function getSelectedText() {
        var text = "";
        if (typeof window.getSelection != "undefined") {
            text = window.getSelection().toString();
        } else if (typeof document.selection != "undefined" && document.selection.type == "Text") {
            text = document.selection.createRange().text;
        }
        if (text != ""){return true}
    }

    // Always save changes
    $(window).bind('beforeunload', function () {
        $('#loading').show();
        postResourceForm();
    })
    function postResourceForm() {
        var data = $('#resource-form').serialize();
        $.ajax({
            type: "POST",
            url: "@Url.Action("ResourceUpdate")",
            data: data,
            traditional:true,
            success: function (result) {
                //do nothing right now, used to be reload
            }
        })
    }

    // Negative Value Check
    $('.btn-next').on('click', function(e){
        e.preventDefault();
        var isInvalidInput = false;

        $("input[name='totalAvailable']").each(function () {
            if (parseFloat(this.value) <= 0 || isNaN(parseFloat(this.value))) {
                $(this).css("background-color", "#e56060");
                $(this).css("color", "#fff");
                isInvalidInput = true; // Set flag
            }
        })

        // Flag was set
        if(isInvalidInput) {
            $('#btn-trigger-negative-value-modal').click();
        }
        else {
            $('#loading').show();
            //postResourceForm();
            location.href = "@Url.Action("Result", "Home")"
        }
    })



    function calculateValues(data, totals, finals) {
        // Member variables
        var hrsPerDay = 8;
        var temp = 0;

        // Data
        var sprintDays = data[0].value;
        var pcntWork = data[1].value;
        var standupDuration = data[2].value;
        var miscHours = data[3].value;
        var timeOff = data[4].value;

        // Totals
        var ttlHours = totals[0];
        var standUps = totals[1];
        var nonDevHours = totals[2];
        var ttlAvailable = totals[3];

        // Finals
        var ttlDevCapac = finals[0];
        var avgPerSprint = finals[1];
        var avgPerWeek = finals[2];

        // Data Calculations
        ttlHours.value = round((sprintDays * (pcntWork / 100) * hrsPerDay), 1);
        standUps.value = round((sprintDays * standupDuration), 1);
        if ( isNaN(parseFloat(miscHours))){
            nonDevHours.value = "???";
            ttlAvailable.value = "???";
        }
        else{
            nonDevHours.value = round((parseFloat(miscHours) + parseFloat(standUps.value)), 1);
            ttlAvailable.value = round((ttlHours.value - nonDevHours.value - timeOff), 1);
        }
        if (ttlAvailable.value > 0){
            $(ttlAvailable).css('background-color', '#eee');
            $(ttlAvailable).css('color', '#000');
        }

        // Finals Calculations
        var ttls = document.getElementsByName("totalAvailable");
        var sprints = document.getElementsByClassName("sprint-name").length;
        for (i = 0; i < ttls.length; i++) {temp += parseFloat(ttls[i].value);}

        if(isNaN(temp)){
            ttlDevCapac.textContent = '???';
            $('.total-dev-capacity-hidden').val(round(parseFloat(temp), 1));
            avgPerSprint.textContent = '???';
            avgPerWeek.textContent = '???';
        }
        else{
            ttlDevCapac.textContent = round(parseFloat(temp), 1)+' hrs';
            $('.total-dev-capacity-hidden').val(round(parseFloat(temp), 1));
            avgPerSprint.textContent = round(parseFloat(temp / sprints), 1)+' hrs';
            avgPerWeek.textContent = round(parseFloat((temp / sprints) / 2), 1)+' hrs';
        }
    }

    function calculateFinals(){
        var totalCapacity = 0;

        var finals = document.getElementsByClassName("final-value");
        var ttlDevCapac = finals[0];
        var avgPerSprint = finals[1];
        var avgPerWeek = finals[2];

        // Finals Calculations
        var ttls = document.getElementsByName("totalAvailable");
        var sprints = document.getElementsByClassName("sprint-name").length;
        for (i = 0; i < ttls.length; i++) {totalCapacity += parseFloat(ttls[i].value);}

        ttlDevCapac.textContent = round(parseFloat(totalCapacity), 1)+' hrs';
        $('.total-dev-capacity-hidden').val(round(parseFloat(totalCapacity), 1));
        avgPerSprint.textContent = round(parseFloat(totalCapacity / sprints), 1)+' hrs';
        avgPerWeek.textContent = round(parseFloat((totalCapacity / sprints) / 2), 1)+' hrs';
    }

    // Prevent rounding errors
    function round(value, decimals) {
        return Number(Math.round(value+'e'+decimals)+'e-'+decimals);
    }

    // Set default values + calculations on select box change
    $(document).on("change", "select", function () {
        var elems = this.parentNode.parentNode.getElementsByClassName("raw-data");
        switch (this.value) {
            case 'leadDev':
                elems[0].value = 10;   // Sprint Days
                elems[1].value = 50;   // % Work
                elems[2].value = 0.25; // Standup Duration
                elems[3].value = 6;    // Misc.
                elems[4].value = 0;    // Time Off
                break;
            case 'seniorDev':
                elems[0].value = 10;   // Sprint Days
                elems[1].value = 70;   // % Work
                elems[2].value = 0.25; // Standup Duration
                elems[3].value = 5;    // Misc.
                elems[4].value = 0;    // Time Off
                break;
            case 'intermediateDev':
                elems[0].value = 10;   // Sprint Days
                elems[1].value = 80;   // % Work
                elems[2].value = 0.25; // Standup Duration
                elems[3].value = 4;    // Misc.
                elems[4].value = 0;    // Time Off
                break;
            case 'juniorDev':
                elems[0].value = 10;   // Sprint Days
                elems[1].value = 90;   // % Work
                elems[2].value = 0.25; // Standup Duration
                elems[3].value = 4;    // Misc.
                elems[4].value = 0;    // Time Off
                break;
            case 'leadQA':
                elems[0].value = 10;   // Sprint Days
                elems[1].value = 50;   // % Work
                elems[2].value = 0.25; // Standup Duration
                elems[3].value = 6;    // Misc.
                elems[4].value = 0;    // Time Off
                break;
            case 'seniorQA':
                elems[0].value = 10;   // Sprint Days
                elems[1].value = 70;   // % Work
                elems[2].value = 0.25; // Standup Duration
                elems[3].value = 5;    // Misc.
                elems[4].value = 0;    // Time Off
                break;
            case 'intermediateQA':
                elems[0].value = 10;   // Sprint Days
                elems[1].value = 80;   // % Work
                elems[2].value = 0.25; // Standup Duration
                elems[3].value = 4;    // Misc.
                elems[4].value = 0;    // Time Off
                break;
            case 'juniorQA':
                elems[0].value = 10;   // Sprint Days
                elems[1].value = 90;   // % Work
                elems[2].value = 0.25; // Standup Duration
                elems[3].value = 4;    // Misc.
                elems[4].value = 0;    // Time Off
                break;
        }
        var data = this.parentNode.parentNode.getElementsByClassName("raw-data");
        var totals = this.parentNode.parentNode.getElementsByClassName("total");
        var finals = document.getElementsByClassName("final-value")
        calculateValues(data, totals, finals);
    })


    // Do calculations during user input
    $(document).on('keyup', 'input', function () {
        if ($(this).hasClass('raw-data')){
            var data = this.parentNode.parentNode.getElementsByClassName("raw-data");
            var totals = this.parentNode.parentNode.getElementsByClassName("total");
            var finals = document.getElementsByClassName("final-value")
            calculateValues(data, totals, finals);
        }
    })

    // Do calculations on page load
    $(document).ready(function(){
        $(".member-row").each(function(){
            if($(this).css('display') != 'none'){
                var data = this.getElementsByClassName("raw-data");
                var totals = this.getElementsByClassName("total");
                var finals = document.getElementsByClassName("final-value")
                calculateValues(data, totals, finals);
            }
        })
    })

    // DOM modication for adding Sprints/Members
    $(document).ready(function () {
        var pageState = @Html.Raw(Json.Encode(Model.pageState));
        var memberTotal = 0;

        for (var i=0; i<pageState.length; i++){
            memberTotal += pageState[i];
        }

        $(document).on('click', '.add-member-btn', function(){
            var sprintNum = this.id;
            var memberNum = pageState[sprintNum];
            addMember(sprintNum, memberNum);
        })

        $('.add-sprint').click(function(e){
            e.preventDefault();
            this.blur();
            pageState.push(0);
            var sprintNum = pageState.length - 1;

            // Populate placeholder sprint with correct HTML
            $('#'+sprintNum).show();
            $('#'+sprintNum).html(''+
            '<div class="panel-heading sprint-heading">'+
                '<input class="sprint-id" id="sprints_'+sprintNum+'__SprintID" name="sprints['+sprintNum+'].SprintID" type="hidden" value="-1">'+
                '<div class="sprint-control-panel editable">'+
                    '<div class="input-group">'+
                        '<h3 id="sprint-name-'+sprintNum+'" class="sprint-name">Enter Sprint Name...</h3>'+
                        '<input id="sprint-name-'+sprintNum+'-hidden" name="sprints['+sprintNum+'].Name" type="hidden" value="Enter Sprint Name..."/>'+
                        '<input class="page-id" id="sprints_'+sprintNum+'__PageID" name="sprints['+sprintNum+'].PageID" type="hidden" value="'+sprintNum+'" />'+
                    '</div>'+
                    '<div class="btn-control-panel">'+
                        '<button type="button" class="btn btn-primary add-member-btn" id="'+sprintNum+'"><span class="glyphicon glyphicon-plus-sign"></span><span class="add-member-text">&nbsp; Add Member</span></button>'+
                        '<span class="sprint-remove glyphicon glyphicon-remove" />'+
                    '</div>'+
                '</div>'+
            '</div>'+
            '<div class="panel-body">'+
                '<table class="table">'+
                    '<thead>'+
                        '<tr>'+
                            '<th><span class="glyphicon glyphicon-trash trash-select-all" /></th>'+
                            '<th><span class="glyphicon glyphicon-user"/></th>'+
                            '<th>Name</th>'+
                            '<th>Sprint Days</th>'+
                            '<th>% Work</th>'+
                            '<th>Total Hrs</th>'+
                            '<th>SU Length</th>'+
                            '<th>Total SU</th>'+
                            '<th>Misc &nbsp;<a href="#" data-toggle="popover" data-placement="bottom" title="Miscellaneous" data-content="Meetings (Backlog Review, Dev Meeting), Demos/Retros, Sprint Planning"><span class="glyphicon glyphicon-question-sign"></span></a></th>'+
                            '<th>Time Off &nbsp;<a href="#" data-toggle="popover" data-placement="bottom" title="Time Off" data-content="Any sick days, holidays, vacation time, or other time off here "><span class="glyphicon glyphicon-question-sign"></span></a></th>'+
                            '<th>Non Dev</th>'+
                            '<th>Capacity</th>'+
                        '</tr>'+
                    '</thead>'+
                    '<tbody id="tbody-'+sprintNum+'">'+
                    '</tbody>'+
                '</table>'+
            '</div>'+'')

            // Append member placeholder and add default member
            $('#tbody-'+sprintNum).append('<tr id="'+sprintNum+'-'+pageState[sprintNum]+'" class="member-row"></tr>')
            addMember(sprintNum, pageState[sprintNum]);

            // Append Sprint placeholder
            $('<div id="'+(sprintNum+1)+'" class="panel panel-default" style="display:none;"></div>').insertAfter('#'+sprintNum);

        });

        function addMember(sprintNum, memberNum){
            $('#'+sprintNum+'-'+memberNum).html(''+
                    '<td><input type="checkbox" name="chkDelete" value="-1"/></td>'+
                    '<td>'+
                        '<select class="role-select" id="members_'+memberTotal+'__Role" name="members['+memberTotal+'].Role">'+
                            '<option value="leadDev" >Lead Dev</option>'+
                            '<option value="seniorDev" >Senior Dev</option>'+
                            '<option value="intermediateDev" >Regular Dev</option>'+
                            '<option value="juniorDev" >Junior Dev</option>'+
                            '<option value="leadQA" >Lead QA</option>'+
                            '<option value="seniorQA" >Senior QA</option>'+
                            '<option value="intermediateQA">Regular QA</option>'+
                            '<option value="juniorQA">Junior QA</option>'+
                        '</select>'+
                    '</td>'+
                    '<td><input type="text" class="form-control form-control-name" id="members_'+memberTotal+'__Name" name="members['+memberTotal+'].Name" placeholder="Name"/></td>'+
                    '<td><input type="number" value="0" min="0" max="99" class="form-control raw-data" id="members_'+memberTotal+'__SprintDays" name="members['+memberTotal+'].SprintDays"/></td>'+
                    '<td><input type="number" value="0" min="0" max="99" class="form-control raw-data" id="members_'+memberTotal+'__PercentWork" name="members['+memberTotal+'].PercentWork"/></td>'+
                    '<td><input type="text" value="0" class="form-control total" Name="totalHours" readonly /></td>'+
                    '<td><input type="number" value="0" class="form-control raw-data" id="members_'+memberTotal+'__StandupDuration" name="members['+memberTotal+'].StandupDuration"/></td>'+
                    '<td><input type="text" value="0" class="form-control total" Name="standUps" readonly /></td>'+
                    '<td><input type="number" value="0" min="0" max="99" class="form-control raw-data" id="members_'+memberTotal+'__Misc" name="members['+memberTotal+'].Misc" /></td>'+
                    '<td><input type="number" value="0" min="0" max="99" class="form-control raw-data" id="members_'+memberTotal+'__TimeOff" name="members['+memberTotal+'].TimeOff"/> </td>'+
                    '<td><input type="text" value="0" class="form-control total" Name="nonDevHours" readonly /></td>'+
                    '<td><input type="text" value="0" class="form-control total" Name="totalAvailable" readonly /></td>'+
                    '<input type="hidden" id="members_'+memberTotal+'__PageID" name="members['+memberTotal+'].PageID" class="page-id" value="'+sprintNum+'"'+
                '</tr>'+'');

            $('<tr id="'+sprintNum+'-'+(memberNum+1)+'" class="member-row">').insertAfter('#'+sprintNum+'-'+memberNum);
            pageState[sprintNum]++;
            memberTotal++;
        }
    });
    function deleteSprint(sprint){
        var data = $(sprint.getElementsByClassName("sprint-id")[0]).val();
        $.ajax({
            type: "POST",
            url: "@Url.Action("ResourceSprintDelete")",
            data: { id: data },
            traditional: true,
            success: function (result) {
                $(sprint).detach().hide();
                $(sprint.getElementsByClassName("page-id")[0]).val(-1);
                calculateFinals();
            }
        })
    }
    function deleteMembers(){
        var data = [];
        $("input[name='chkDelete']:checked").each(function () {
            data.push($(this).val());
        });
        if (data.length == 0) {
            return;
        }
        else if (data.length >0) {
            $.ajax({
                type: "POST",
                url: "@Url.Action("ResourceMemberDelete")",
                data: { id: data },
                traditional: true,
                success: function (result) {
                    //Modify DOM
                    $("input[name='chkDelete']:checked").each(function () {
                        $(this.parentNode.parentNode.getElementsByClassName("page-id")).val(-1);
                        $(this.parentNode.parentNode.getElementsByClassName("raw-data")).each(function(){
                            $(this).removeClass('raw-data');
                        })
                        $(this.parentNode.parentNode).detach().hide();
                    })
                    calculateFinals();
                }
            })
        }
    }
    $(document).on('click', function (e) {
        $('[data-toggle="popover"],[data-original-title]').each(function () {
            if (!$(this).is(e.target) && $(this).has(e.target).length === 0 && $('.popover').has(e.target).length === 0 ) {
                (($(this).popover('hide').data('bs.popover') || {}).inState || {}).click = false
            }
        });
    });

    /* smooth auto horizontal scroll for responsiveness */
    $('.form-control').on('focus', function() {
        var panel = $(this).closest('.panel-body')[0];
        $(panel).stop().animate({scrollLeft:($(this).offset().left - 400)}, 300);
    });

    /* title editing */
    $(document).on('click', '.sprint-name', function(e) {
        e.preventDefault();
        setToEdit(this);
    });
    $(document).on('blur', '.sprint-name-edit', function(e) {
        e.preventDefault();
        setToText(this);
    });
    $(document).on('keydown', '.sprint-name-edit', function(e){
        if(e.keyCode == 13 && $('.sprint-name-edit').is(':focus')){ //enter button
            setToText(this);
        }
    })
    function setToEdit(sprintName){
        $(sprintName.parentNode.parentNode).removeClass('editable')
        var text = $(sprintName).text();
        var id = $(sprintName).attr('id');
        $(sprintName).replaceWith("<input type='text' class='form-control input-lg sprint-name-edit' value='"+text+"' maxlength='45' id='"+id+"'/> ");
        $('.sprint-name-edit').focus();
        $('.sprint-name-edit').select();
    }
    function setToText(sprintNameEdit){
        $(sprintNameEdit.parentNode.parentNode).addClass('editable')
        var text = $.trim($(sprintNameEdit).val());
        var id = $(sprintNameEdit).attr('id');
        if (text != ""){
            $(sprintNameEdit).replaceWith("<h3 class='sprint-name' id='"+id+"'>"+text+"</h3>");
            $('#'+id+'-hidden').val(text);
        }
        else{
            $(sprintNameEdit).replaceWith("<h3 class='sprint-name' id='"+id+"'>Enter sprint name...</h3>");
        }
    }

    /* delete confirmations */
    $(document).on('click', '.sprint-remove', function(e){
        var sprint = this.parentNode.parentNode.parentNode.parentNode;
        $('#btn-trigger-delete-sprint-modal').click()
        $('#btn-delete-sprint-yes').on('click', function(){
            deleteSprint(sprint);
        })
    });
    $('.delete-selected').on('click', function(e){
        e.preventDefault();
        var checkBoxIsChecked = false;
        $('input[type="checkbox"]:checked').each(function(){
            checkBoxIsChecked = true;
        })
        if(checkBoxIsChecked){
            $('#btn-trigger-delete-member-modal').click();
            $('#btn-delete-member-yes').on('click', function(){
                deleteMembers();
            })
        }
    });

    // Navigate to previous page
    $('.btn-prev').on('click', function(e) {
        e.preventDefault();
        window.location.href = "@Url.Action("Story", "Home")"
    })

    // Select all for deletion functionality
    $(document).on('click', '.trash-select-all', function () {
        var didCheck = false;
        $(this.parentNode.parentNode.parentNode.parentNode).find('input[type="checkbox"]').each(function () {
            if ($(this).prop('checked') == false) {
                $(this).prop('checked', true);
                didCheck = true;
            }
        })
        if (!didCheck) {
            $(this.parentNode.parentNode.parentNode.parentNode).find('input[type="checkbox"]').each(function () {
                $(this).prop('checked', false);
            })
        }
    })
</script>
